<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>√âv√©nements CGR, Arena, Republic Corner, Parc Expo & TAP ‚Äì Poitiers</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9SBQ1Y2G8H"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9SBQ1Y2G8H');
    </script>

    <style>
      :root {
        --bg: #f7f7f7;
        --panel: #ffffff;
        --muted: #555;
        --text: #111;
        --brand: #097d4c;
        --brand-2: #13b46d;
        --border: #ddd;
        --card: #fff;
      }

      * { box-sizing: border-box; }

      html, body {
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
        margin: 0;
      }

      .hero {
        background-image: url('https://www.hifrance.org/wp-content/uploads/2025/10/Poitiers-Site-HI-Banniere.jpg');
        background-size: cover;
        background-position: center;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-shadow: 0 2px 6px rgba(0,0,0,0.4);
      }

      .hero h1 {
        background: rgba(0,0,0,0.3);
        padding: 12px 24px;
        border-radius: 12px;
        font-size: clamp(26px, 3vw, 36px);
      }

      /* Barre de recherche + filtres */
      .search-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f7f7f7;
        padding: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid var(--border);
      }

      .search-bar input {
        width: 100%;
        max-width: 500px;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        outline: none;
        transition: box-shadow 0.2s;
        margin-bottom: 10px;
      }

      .search-bar input:focus {
        box-shadow: 0 0 0 2px var(--brand-2);
        border-color: var(--brand);
      }

      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .filter-item {
        align-items: center;
        gap: 6px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-item:hover {
        border-color: var(--brand);
        background: #f0fef8;
      }

      .filter-item input[type="checkbox"] {
        accent-color: var(--brand);
        cursor: pointer;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 16px;
      }

      .section-title {
        margin-top: 30px;
        margin-bottom: 12px;
        font-size: 20px;
        font-weight: 700;
        color: var(--brand);
        border-left: 5px solid var(--brand);
        padding-left: 8px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        margin-top: 16px;
      }

      @media (min-width: 700px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }

      @media (min-width: 1000px) {
        .grid { grid-template-columns: 1fr 1fr 1fr; }
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      }

      .cover {
        position: relative;
        aspect-ratio: 16 / 9;
        background-size: cover;
        background-position: center;
      }

      .badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 12px;
        color: var(--brand);
        font-weight: 600;
      }

      .content {
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .content h3 { margin: 0; font-size: 16.5px; }
      .meta { font-size: 13px; color: var(--muted); }
      .synopsis { font-size: 13px; line-height: 1.5; color: var(--text); max-height: 3.5em; overflow: hidden; position: relative; transition: max-height 0.4s ease; }
      .synopsis.expanded { max-height: 300px; }

      .toggle-btn { background: none; border: none; color: var(--brand); font-weight: 600; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; padding: 0; }
      .toggle-btn::after { content: "‚ñº"; font-size: 11px; transition: transform 0.3s ease; }
      .toggle-btn.active::after { transform: rotate(180deg); }

      .actions { margin-top: auto; display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 0 14px 14px 14px; }
      .btn { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: white; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; text-decoration: none; font-weight: 600; }
      .ghost { border: 1px solid var(--brand); background: transparent; color: var(--brand); padding: 8px 12px; border-radius: 10px; text-decoration: none; }

      footer { text-align: center; color: var(--muted); font-size: 12px; margin: 24px 0; }
      /* üåø Menu d√©roulant CGR corrig√© et coh√©rent */
      .dropdown {
        position: relative;
        user-select: none;
      }
      
      .dropdown-toggle {
        align-items: center;
        cursor: pointer;
      }
      
      .dropdown-content {
        display: none;
        position: absolute;
        top: 110%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 10px 14px;
        min-width: 200px;
        z-index: 999;
        text-align: left;
      }
      
      .dropdown-content label {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
        font-size: 15px;
        padding: 6px 10px;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
        box-sizing: border-box;
      }
      
      .dropdown-content label:hover {
        background: #f6fdf9;
        border-radius: 6px;
      }
      
      .dropdown-content input[type="checkbox"] {
          accent-color: var(--brand);
          transform: scale(1.1);
          flex-shrink: 0;
          width: 20px; /* largeur fixe pour un alignement parfait */
        }


      .dropdown-content label span {
        flex: 1;
        text-align: left;
      }
      
      .dropdown-content label:hover {
          background: #f6fdf9;
          border-radius: 6px;
        }

            
      .dropdown:hover .dropdown-content,
      .dropdown.active .dropdown-content {
        display: block;
      }
      
      /* Corrige le d√©bordement du menu */
      .filters {
        position: relative;
        z-index: 5;
      }

    </style>
  </head>

  <body>
    <div class="hero"><h1>√âv√©nements √† Poitiers</h1></div>

    <!-- üîç Barre de recherche + filtres -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un √©v√©nement √† Poitiers (ex : concert, film, humour...)" />
      <div class="filters">
        <div class="filter-item dropdown">
          <label class="dropdown-toggle">
            <input type="checkbox" value="CGR" checked /> üé¨ CGR ‚ñº
          </label>
          <div class="dropdown-content">
            <label><input type="checkbox" value="CGR Castille" checked /> Castille</label>
            <label><input type="checkbox" value="CGR Buxerolles" checked /> Buxerolles</label>
            <label><input type="checkbox" value="CGR Fontaine-le-Comte" checked /> Fontaine-le-Comte</label>
          </div>
        </div>
      
        <label class="filter-item"><input type="checkbox" value="Arena" checked /> üé§ Arena</label>
        <label class="filter-item"><input type="checkbox" value="Republic" checked /> üé≠ Republic Corner</label>
        <label class="filter-item"><input type="checkbox" value="Parc Expo" checked /> üèõÔ∏è Parc Expo</label>
        <label class="filter-item"><input type="checkbox" value="TAP" checked /> üé≠ TAP Poitiers</label>
      </div>



    </div>

    <div class="wrap" id="mainContent">
      <h2 class="section-title">üé¨ Films √† l'affiche (CGR)</h2>
      <section class="grid" id="gridCGR"></section>

      <h2 class="section-title">üé§ Concerts & Spectacles (Arena)</h2>
      <section class="grid" id="gridArena"></section>

      <h2 class="section-title">üé≠ Soir√©es & Humour (Republic Corner)</h2>
      <section class="grid" id="gridRC"></section>

      <h2 class="section-title">üèõÔ∏è √âv√©nements (Parc Expo Grand Poitiers)</h2>
      <section class="grid" id="gridExpo"></section>

      <h2 class="section-title">üé≠ TAP Poitiers (Cin√©ma & Spectacles)</h2>
      <section class="grid" id="gridTAP"></section>

      <footer>‚ú¶ Donn√©es issues de <strong>events.json</strong> (CGR, Arena, Republic Corner, Parc Expo & TAP).</footer>
    </div>

    <script>
      let allEvents = [];

      async function loadEvents() {
        const r = await fetch('./events.json?v=' + Date.now(), { cache: 'no-store' });
        return r.ok ? await r.json() : { events: [] };
      }

      function daysUntil(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        const now = new Date();
        const diff = Math.ceil((d - now) / 86400000);
        if (diff < 0) return '';
        if (diff === 0) return 'Aujourd‚Äôhui';
        if (diff === 1) return 'Demain';
        return 'J-' + diff;
      }

      function daysUntilText(dateText) {
        if (!dateText) return '';
        const match = dateText.match(/(\d{1,2})\s*(?:[a-z√©√ª]+\s*)?(\d{4})?/i);
        const yearMatch = dateText.match(/(\d{4})/);
        const year = yearMatch ? parseInt(yearMatch[1]) : new Date().getFullYear();

        const mois = {
          janvier: 'January', f√©vrier: 'February', mars: 'March', avril: 'April',
          mai: 'May', juin: 'June', juillet: 'July', ao√ªt: 'August',
          septembre: 'September', octobre: 'October', novembre: 'November', d√©cembre: 'December'
        };
        let monthName = null;
        for (const [fr, en] of Object.entries(mois)) {
          if (dateText.toLowerCase().includes(fr)) {
            monthName = en;
            break;
          }
        }
        if (!monthName || !match) return '';
        const day = parseInt(match[1]);
        const d = new Date(`${monthName} ${day}, ${year}`);
        if (isNaN(d)) return '';
        const now = new Date();
        const diff = Math.ceil((d - now) / 86400000);
        if (diff < 0) return '';
        if (diff === 0) return 'Aujourd‚Äôhui';
        if (diff === 1) return 'Demain';
        return 'J-' + diff;
      }

      function cleanArenaDate(text) {
        if (!text) return '';
        return text.replace(/^.*?(dimanche|lundi|mardi|mercredi|jeudi|vendredi|samedi)/i, '$1');
      }

      function renderAll(events) {
        const grids = {
          CGR: document.getElementById('gridCGR'),
          Arena: document.getElementById('gridArena'),
          RC: document.getElementById('gridRC'),
          Expo: document.getElementById('gridExpo'),
          TAP: document.getElementById('gridTAP')
        };
        Object.values(grids).forEach(g => g.innerHTML = '');

        // üé¨ CGR
        events.filter(ev => ev.cinema?.includes('CGR')).forEach(ev => {
          const poster = ev.poster || ev.image || '';
          const rel = daysUntil(ev.release);
          const genres = ev.genres || 'Genres non pr√©cis√©s';
          const desc = ev.description || ev.synopsis || '‚Äî';
          grids.CGR.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">${rel ? `<div class="badge">${rel}</div>` : ''}</div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.cinema} ¬∑ ${genres} ¬∑ ${ev.duration || 'Dur√©e inconnue'}</div>
                <p class="synopsis">${desc}</p>
                <button class="toggle-btn">Voir plus</button>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Site CGR</a>
                <a class="btn" href="${ev.source}" target="_blank">Voir les horaires</a>
              </div>
            </article>`);
        });

        // üé§ ARENA
        events.filter(ev => ev.cinema?.includes('Arena')).forEach(ev => {
          const poster = ev.poster || ev.image || '';
          const rel = daysUntil(ev.release);
          const date = cleanArenaDate(ev.date);
          grids.Arena.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">${rel ? `<div class="badge">${rel}</div>` : ''}</div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">Arena Futuroscope ¬∑ ${date}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.reservation || ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });

        // üé≠ REPUBLIC CORNER
        events.filter(ev => ev.cinema?.includes('Republic')).forEach(ev => {
          const poster = ev.poster || '';
          const rel = daysUntil(ev.date);
          grids.RC.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">${rel ? `<div class="badge">${rel}</div>` : ''}</div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.address || 'Espace Republic Corner, Poitiers'}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Billetterie</a>
                <a class="btn" href="${ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });

        // üèõÔ∏è PARC EXPO
        events.filter(ev => ev.cinema?.includes('Parc Expo')).forEach(ev => {
          const poster = ev.poster || '';
          const rel = daysUntil(ev.date);
          grids.Expo.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">${rel ? `<div class="badge">${rel}</div>` : ''}</div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">Parc Expo Grand Poitiers</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.source}" target="_blank">Voir l'√©v√©nement</a>
              </div>
            </article>`);
        });

        // üé≠ TAP CIN√âMA
        events.filter(ev => ev.cinema?.includes('TAP Cin√©ma')).forEach(ev => {
          const poster = ev.poster || '';
          const genres = ev.genres || 'Genres non pr√©cis√©s';
          const desc = ev.description || '‚Äî';
          grids.TAP.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.cinema} ¬∑ ${genres} ¬∑ ${ev.duration || 'Dur√©e inconnue'}</div>
                <p class="synopsis">${desc}</p>
                <button class="toggle-btn">Voir plus</button>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Site TAP Cin√©ma</a>
                <a class="btn" href="${ev.source}" target="_blank">Voir le film</a>
              </div>
            </article>`);
        });

        // üé≠ TAP SPECTACLES (avec badge J-X)
        events.filter(ev => ev.cinema === 'TAP Poitiers').forEach(ev => {
          const poster = ev.poster || '';
          const date = cleanArenaDate(ev.date);
          const rel = daysUntilText(ev.date);
          grids.TAP.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">
                ${rel ? `<div class="badge">${rel}</div>` : ''}
              </div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">TAP Poitiers ¬∑ ${date}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.reservation || ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });
      }

      function filterEvents() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const checkboxes = Array.from(document.querySelectorAll('.filters input[type="checkbox"]'));
        const checkedValues = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
      
        const cgrGlobal = document.querySelector('.dropdown-toggle input[value="CGR"]');
        const cgrSubs = Array.from(document.querySelectorAll('.dropdown-content input[type="checkbox"]'));
        const activeCGRSubs = cgrSubs.filter(cb => cb.checked).map(cb => cb.value);
      
        // üéØ Synchronisation auto du CGR principal
        if (activeCGRSubs.length === 0) {
          cgrGlobal.checked = false;
        } else {
          cgrGlobal.checked = true;
        }
      
        const filtered = allEvents.filter(ev => {
          const textMatch =
            ev.title?.toLowerCase().includes(query) ||
            ev.description?.toLowerCase().includes(query) ||
            ev.cinema?.toLowerCase().includes(query);
      
          let match = false;
      
          // üé¨ Gestion CGR pr√©cise
          if (ev.cinema?.startsWith('CGR')) {
            if (cgrGlobal.checked && activeCGRSubs.length === 0) {
              // CGR global seul ‚Üí on affiche tout
              match = true;
            } else {
              // Sinon : on affiche seulement les sous-cin√©mas coch√©s
              match = activeCGRSubs.includes(ev.cinema);
            }
          } else {
            // Autres cin√©mas
            match = checkedValues.some(f => ev.cinema?.toLowerCase().includes(f.toLowerCase()));
          }
      
          return textMatch && match;
        });
      
        renderAll(filtered);
      }



      (async function() {
        const data = await loadEvents();
        allEvents = data.events || [];
        renderAll(allEvents);
      
        // Recherche texte
        document.getElementById('searchInput').addEventListener('input', filterEvents);
      
        // Ajout d'√©couteurs sur TOUS les filtres (y compris dropdowns)
        function bindFilterListeners() {
          document.querySelectorAll('.filters input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', filterEvents);
          });
        }

                // Synchronisation CGR principal ‚Üî sous-cat√©gories
        function bindCGRLogic() {
          const cgrGlobal = document.querySelector('.dropdown-toggle input[value="CGR"]');
          const cgrSubs = document.querySelectorAll('.dropdown-content input[type="checkbox"]');
        
          // Si on clique sur le CGR global ‚Üí active/d√©sactive tous les sous-cin√©s
          cgrGlobal.addEventListener('change', () => {
            cgrSubs.forEach(cb => (cb.checked = cgrGlobal.checked));
            filterEvents();
          });
        
          // Si on coche/d√©coche un sous-cin√© ‚Üí met √† jour l‚Äô√©tat du global
          cgrSubs.forEach(cb => {
            cb.addEventListener('change', () => {
              const allUnchecked = Array.from(cgrSubs).every(sub => !sub.checked);
              cgrGlobal.checked = !allUnchecked;
              filterEvents();
            });
          });
        }
        
        bindFilterListeners();
        bindCGRLogic();
        setupDropdownToggle();
        
              
        // G√©rer ouverture/fermeture du menu sans interf√©rer avec la case
        function setupDropdownToggle() {
          const dropdown = document.querySelector('.dropdown');
          const toggle = dropdown.querySelector('.dropdown-toggle');
          const checkbox = toggle.querySelector('input[type="checkbox"]');
        
          // Emp√™che le clic sur la case de fermer le menu
          checkbox.addEventListener('click', e => {
            e.stopPropagation(); // ‚õî bloque la propagation du clic vers le parent
          });
        
          // Clic sur la zone "CGR ‚ñº" (hors case) ‚Üí ouvre/ferme le menu
          toggle.addEventListener('click', e => {
            // Ne pas d√©clencher si clic directement sur la case
            if (e.target === checkbox) return;
            e.preventDefault();
            dropdown.classList.toggle('active');
          });
        }
        
        // Fermer le menu si clic ailleurs
        document.addEventListener('click', e => {
          document.querySelectorAll('.dropdown.active').forEach(d => {
            if (!d.contains(e.target)) d.classList.remove('active');
          });
        });
      })();
    </script>
  </body>
</html>
