<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>√âv√©nements √† Poitiers ‚Äì CGR, Arena, TAP, Confort Moderne & plus</title>

    <style>
      :root {
        --bg: #f7f7f7;
        --text: #111;
        --muted: #555;
        --brand: #097d4c;
        --brand-2: #13b46d;
        --border: #ddd;
        --card: #fff;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
        overflow-x: hidden; /* ‚úÖ emp√™che tout scroll horizontal */
      }

      .hero {
        background-image: url('https://www.hifrance.org/wp-content/uploads/2025/10/Poitiers-Site-HI-Banniere.jpg');
        background-size: cover;
        background-position: center;
        height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-shadow: 0 2px 6px rgba(0,0,0,0.4);
      }

      .hero h1 {
        background: rgba(0,0,0,0.35);
        padding: 14px 28px;
        border-radius: 12px;
        font-size: clamp(26px, 3vw, 38px);
      }

      .search-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--bg);
        padding: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid var(--border);
      }

      /* ---- Voir plus / Voir moins ---- */
      .toggle-btn{
        background:none;
        border:0;
        padding:0;
        margin-top:6px;
        color:var(--brand);
        font-weight:700;
        font-size:14px;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:6px;
      }
      .toggle-btn::after{
        content:"‚ñº";
        font-size:12px;
        transition:transform .2s ease;
      }
      .toggle-btn.active::after{
        transform:rotate(180deg);
      }
      

      .search-bar input {
        width: 100%;
        max-width: 550px;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        margin-bottom: 10px;
      }

      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .filter-item {
        align-items: center;
        gap: 6px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
      }

      .filter-item:hover {
        border-color: var(--brand);
        background: #f0fef8;
      }

      .filter-item input[type="checkbox"] {
        accent-color: var(--brand);
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px;
      }

      .section-title {
        margin-top: 36px;
        margin-bottom: 12px;
        font-size: 22px;
        font-weight: 700;
        color: var(--brand);
        border-left: 5px solid var(--brand);
        padding-left: 8px;
      }

      /* === CARROUSELS === */
      .carousel-container {
        position: relative;
        overflow: visible; /* ‚úÖ indispensable pour voir les fl√®ches √† l‚Äôext√©rieur */
        width: 100%;
        padding: 0 0; /* ‚úÖ supprime les marges internes pour un alignement plus net */
      }


      .grid {
        display: flex;
        gap: 16px;
        transition: transform 0.6s ease-in-out;
        will-change: transform;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        flex: 0 0 25%; /* 4 cartes visibles */
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      }

      @media (max-width: 1024px) {
        .card { flex: 0 0 33.333%; } /* 3 cartes */
      }

      @media (max-width: 800px) {
        .card { flex: 0 0 50%; } /* 2 cartes */
      }

      @media (max-width: 550px) {
        .card { flex: 0 0 100%; } /* 1 carte */
      }

      .cover {
        position: relative;
        aspect-ratio: 16 / 9;
        background-size: cover;
        background-position: center;
      }

      .badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 12px;
        color: var(--brand);
        font-weight: 600;
      }

      .content {
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .content h3 { margin: 0; font-size: 16.5px; }
      .meta { font-size: 13px; color: var(--muted); }
      .synopsis{
        font-size:13px;
        line-height:1.5;
        color:var(--text);
        max-height:3.5em;   /* texte r√©duit par d√©faut */
        overflow:hidden;
        transition:max-height .3s ease;
      }
      .synopsis.expanded{
        max-height:300px;   /* ouvert */
      }

      .actions {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 0 14px 14px 14px;
      }

      .btn {
        background: linear-gradient(135deg, var(--brand), var(--brand-2));
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
      }

      .ghost {
        border: 1px solid var(--brand);
        background: transparent;
        color: var(--brand);
        padding: 8px 12px;
        border-radius: 10px;
        text-decoration: none;
      }

      .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: radial-gradient(circle at center, var(--brand) 40%, var(--brand) 200%);
        border: 2px solid var(--brand);
        border-radius: 50%;
        width: 52px;
        height: 52px;
        font-size: 26px;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        transition: all 0.3s ease;
      }

      .carousel-btn:hover {
        background: var(--brand);
        color: white;
        box-shadow: 0 20px 80px var(--brand);
      }
      
      /* === Boutons lat√©raux responsives === */
      .carousel-btn.left,
      .carousel-btn.right {
        top: 50%;
        transform: translateY(-50%);
      }
      
      /* Position dynamique selon largeur du container */
      .carousel-btn.left {
        left: max(-3vw, -40px); /* s‚Äôajuste avec la taille de l‚Äô√©cran */
      }
      
      .carousel-btn.right {
        right: max(-3vw, -40px);
      }
      
      /* Si l‚Äô√©cran devient trop petit, rapproche automatiquement les fl√®ches */
      @media (max-width: 1300px) {
        .carousel-btn.left { left: -20px; }
        .carousel-btn.right { right: -20px; }
      }
      
      @media (max-width: 1024px) {
        .carousel-btn.left { left: -10px; }
        .carousel-btn.right { right: -10px; }
      }


      /* üåø Menu d√©roulant CGR corrig√© */
      .dropdown {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .dropdown-toggle {
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }
      
      .dropdown-content {
        display: none;
        align-items: flex-start;
        position: absolute;
        top: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 10px 14px;
        min-width: 200px;
        z-index: 999;
      }
      
      .dropdown-content label {
        gap: 10px;
        font-size: 14px;
        color: var(--text);
        padding: 6px 10px;
        cursor: pointer;
        transition: background 0.2s ease;
        width: 100%;
        border-radius: 6px;
      }
      
      .dropdown-content label:hover {
        background: #f6fdf9;
      }
      
      .dropdown-content input[type="checkbox"] {
        accent-color: var(--brand);
        transform: scale(1.1);
        flex-shrink: 0;
      }
      
      .dropdown:hover .dropdown-content,
      .dropdown.active .dropdown-content {
        display: flex;
      }
      
      /* Pour √©viter les d√©bordements */
      .filters {
        position: relative;
        z-index: 5;
      }
      
      footer {
        text-align: center;
        color: var(--muted);
        font-size: 12px;
        margin: 40px 0;
      }

      .dropdown-toggle input[type="checkbox"] {
        margin-right: 4px;
      }
      
      .dropdown-toggle::after {
        content: "‚ñº";
        font-size: 11px;
        color: var(--brand);
        margin-left: 4px;
        transition: transform 0.2s ease;
      }
      
      .dropdown.active .dropdown-toggle::after {
        transform: rotate(180deg);
      }

      /* === VERSION MOBILE : carrousel tactile === */
      @media (max-width: 768px) {
        .carousel-btn {
          display: none !important; /* ‚ùå cache les fl√®ches sur mobile */
        }
      
        .grid {
          overflow-x: auto;           /* ‚úÖ active le scroll horizontal tactile */
          scroll-snap-type: x mandatory; /* ‚úÖ effet de "snap" fluide */
          -webkit-overflow-scrolling: touch; /* ‚úÖ inertie iOS */
          gap: 12px;
          padding-bottom: 10px; /* espace pour √©viter les coupures */
        }
      
        .card {
          scroll-snap-align: start; /* ‚úÖ chaque carte se cale proprement */
        }
      
        body {
          overflow-x: hidden; /* ‚úÖ √©vite le d√©bordement global du body */
        }
      }

      /* ‚úÖ Correction du menu d√©roulant CGR sur mobile */
      @media (max-width: 768px) {
        .dropdown-content {
          left: 0 !important;
          right: 0 !important;
          transform: none !important;
          min-width: unset;
          width: 90vw; /* prend 90% de la largeur de l‚Äô√©cran */
          margin: 0 auto; /* centr√© visuellement */
          border-radius: 10px;
        }
      
        .dropdown-content label {
          justify-content: flex-start;
          text-align: left;
        }
      }
            
            
    </style>
  </head>

  <body>
    <div class="hero"><h1>√âv√©nements √† Poitiers</h1></div>

    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un √©v√©nement √† Poitiers (ex : concert, film, humour...)" />
      <div class="filters">
        <div class="filter-item dropdown">
          <label class="dropdown-toggle">
            <input type="checkbox" value="CGR" checked />CGR
          </label>
          <div class="dropdown-content">
            <label><input type="checkbox" value="CGR Castille" checked /> Castille</label>
            <label><input type="checkbox" value="CGR Buxerolles" checked /> Buxerolles</label>
            <label><input type="checkbox" value="CGR Fontaine-le-Comte" checked /> Fontaine-le-Comte</label>
          </div>
        </div>

        <label class="filter-item"><input type="checkbox" value="Arena" checked />Arena</label>
        <label class="filter-item"><input type="checkbox" value="Republic" checked />Republic Corner</label>
        <label class="filter-item"><input type="checkbox" value="Parc Expo" checked />Parc Expo</label>
        <label class="filter-item"><input type="checkbox" value="TAP" checked />TAP Poitiers</label>
        <label class="filter-item"><input type="checkbox" value="Confort Moderne" checked />Confort Moderne</label>
        <label class="filter-item"><input type="checkbox" value="Maison des 3 Quartiers" checked />Maison des 3 Quartiers</label>
      </div>
    </div>

    <div class="wrap">
      <h2 class="section-title">üé¨ Films √† l'affiche (CGR)</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridCGR">‚Äπ</button>
        <section class="grid" id="gridCGR"></section>
        <button class="carousel-btn right" data-target="gridCGR">‚Ä∫</button>
      </div>

      <h2 class="section-title">üé§ Concerts & Spectacles (Arena)</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridArena">‚Äπ</button>
        <section class="grid" id="gridArena"></section>
        <button class="carousel-btn right" data-target="gridArena">‚Ä∫</button>
      </div>

      <h2 class="section-title">üé≠ Soir√©es & Humour (Republic Corner)</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridRC">‚Äπ</button>
        <section class="grid" id="gridRC"></section>
        <button class="carousel-btn right" data-target="gridRC">‚Ä∫</button>
      </div>

      <h2 class="section-title">üèõÔ∏è √âv√©nements (Parc Expo Grand Poitiers)</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridExpo">‚Äπ</button>
        <section class="grid" id="gridExpo"></section>
        <button class="carousel-btn right" data-target="gridExpo">‚Ä∫</button>
      </div>

      <h2 class="section-title">üé≠ TAP Poitiers (Cin√©ma & Spectacles)</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridTAP">‚Äπ</button>
        <section class="grid" id="gridTAP"></section>
        <button class="carousel-btn right" data-target="gridTAP">‚Ä∫</button>
      </div>

      <h2 class="section-title">üé∏ Confort Moderne</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridCM">‚Äπ</button>
        <section class="grid" id="gridCM"></section>
        <button class="carousel-btn right" data-target="gridCM">‚Ä∫</button>
      </div>

      <h2 class="section-title">üè¢ Maison des 3 Quartiers</h2>
      <div class="carousel-container">
        <button class="carousel-btn left" data-target="gridM3Q">‚Äπ</button>
        <section class="grid" id="gridM3Q"></section>
        <button class="carousel-btn right" data-target="gridM3Q">‚Ä∫</button>
      </div>

      

      <footer>‚ú¶ Donn√©es issues de <strong>events.json</strong>.</footer>
    </div>

    <script>
      let allEvents = [];

      async function loadEvents() {
        const r = await fetch('./events.json?v=' + Date.now(), { cache: 'no-store' });
        return r.ok ? await r.json() : { events: [] };
      }

      /* === FONCTIONS UTILITAIRES === */
      function daysUntil(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        const now = new Date();
        const diff = Math.ceil((d - now) / 86400000);
        if (diff < 0) return '';
        if (diff === 0) return 'Aujourd‚Äôhui';
        if (diff === 1) return 'Demain';
        return 'J-' + diff;
      }

      function daysUntilText(dateText) {
        if (!dateText) return '';
        const now = new Date();
        const target = new Date(dateText);
        const diff = Math.ceil((target - now) / 86400000);
        return diff > 0 ? 'J-' + diff : '';
      }

      function cleanArenaDate(text) {
        if (!text) return '';
        return text.replace(/^.*?(dimanche|lundi|mardi|mercredi|jeudi|vendredi|samedi)/i, '$1');
      }

      function bindToggleButtons() {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
          const content = btn.closest('.content');
          const p = content.querySelector('.synopsis');
      
          const full = p.dataset.full || '';
          const short = p.innerText;
      
          btn.addEventListener('click', () => {
            const expanded = p.classList.toggle('expanded');
      
            if (expanded) {
              p.textContent = full;
              btn.textContent = "Voir moins";
              btn.classList.add("active");
            } else {
              p.textContent = short;
              btn.textContent = "Voir plus";
              btn.classList.remove("active");
            }
          });
        });
      }

      function cleanM3QDescription(ev) {
        let desc = ev.description || '';
      
        // 1) Retire le titre du d√©but s‚Äôil est pr√©sent dans la description
        if (desc.toLowerCase().startsWith(ev.title?.toLowerCase())) {
          desc = desc.substring(ev.title.length).trim();
        }
      
        // 2) Retire la date en doublon si elle apparait au d√©but du texte
        if (ev.date && desc.toLowerCase().startsWith(ev.date.toLowerCase())) {
          desc = desc.substring(ev.date.length).trim();
        }
      
        // 3) Nettoyage des multiples espaces / nouvelles lignes
        desc = desc.replace(/\s+/g, ' ').trim();
      
        return desc;
      }

      /* === RENDER ALL (int√©gralement conserv√©e) === */
      function renderAll(events) {
        const grids = {
          CGR: document.getElementById('gridCGR'),
          Arena: document.getElementById('gridArena'),
          RC: document.getElementById('gridRC'),
          Expo: document.getElementById('gridExpo'),
          TAP: document.getElementById('gridTAP'),
          CM: document.getElementById('gridCM'),
          M3Q: document.getElementById('gridM3Q')
        };
      
        Object.values(grids).forEach(g => {
          g.innerHTML = '';
          g.style.transform = 'translateX(0px)';
          g.dataset.offset = 0;
        });
      
        // --- FONCTION UTILITAIRE : met √† jour la visibilit√© des fl√®ches ---
        function updateCarouselVisibility(key) {
          const container = grids[key]?.closest('.carousel-container');
          if (!container) return;
          const hasCards = grids[key]?.children.length > 0;
          container.querySelectorAll('.carousel-btn').forEach(btn => {
            btn.style.display = hasCards ? 'flex' : 'none';
          });
          container.previousElementSibling.style.display = hasCards ? 'block' : 'none'; // cache le titre
        }
      
        // === CGR ===
        events.filter(ev => ev.cinema?.includes('CGR')).forEach(ev => {
          const poster = ev.poster || ev.image || '';
          const genres = ev.genres || 'Genres non pr√©cis√©s';
          const desc = ev.description || ev.synopsis || '‚Äî';
          grids.CGR.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"><div class="badge">Actuellement √† l'affiche</div></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.cinema} ¬∑ ${genres} ¬∑ ${ev.duration || 'Dur√©e inconnue'}</div>
                <p class="synopsis">${desc}</p>
                <button class="toggle-btn">Voir plus</button>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Site CGR</a>
                <a class="btn" href="${ev.source}" target="_blank">Voir les horaires</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('CGR');
      
        // === ARENA ===
        events.filter(ev => ev.cinema?.includes('Arena')).forEach(ev => {
          const poster = ev.poster || ev.image || '';
          const date = cleanArenaDate(ev.date);
          grids.Arena.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">Arena Futuroscope ¬∑ ${date}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.reservation || ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('Arena');
      
        // === REPUBLIC CORNER ===
        events.filter(ev => ev.cinema?.includes('Republic')).forEach(ev => {
          const poster = ev.poster || '';
          grids.RC.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.address || 'Espace Republic Corner, Poitiers'}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Billetterie</a>
                <a class="btn" href="${ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('RC');
      
        // === PARC EXPO ===
        events.filter(ev => ev.cinema?.includes('Parc Expo')).forEach(ev => {
          const poster = ev.poster || '';
          grids.Expo.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">Parc Expo Grand Poitiers</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.source}" target="_blank">Voir</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('Expo');
      
        // === TAP ===
        events.filter(ev => ev.cinema?.includes('TAP')).forEach(ev => {
          const poster = ev.poster || '';
          grids.TAP.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">${ev.cinema}</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('TAP');
      
        // === CONFORT MODERNE ===
        events.filter(ev => ev.cinema?.includes('Confort Moderne')).forEach(ev => {
          const poster = ev.poster || '';
          grids.CM.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');"></div>
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">Confort Moderne</div>
              </div>
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Plus d'infos</a>
                <a class="btn" href="${ev.source}" target="_blank">R√©server</a>
              </div>
            </article>`);
        });
        updateCarouselVisibility('CM');

        // === MAISON DES 3 QUARTIERS ===
        events.filter(ev => ev.cinema?.includes('Maison des 3 Quartiers')).forEach(ev => {
        
          const poster = ev.poster || ev.image || '';
          const dateISO = ev.date || null;
        
          // Badge J-X
          let badge = '';
          if (dateISO) {
            const diffText = daysUntil(dateISO);
            if (diffText) {
              badge = `<div class="badge">${diffText}</div>`;
            }
          }
        
          // Texte affich√© : si description vide ‚Üí on montre le subtitle
          const summary = ev.description && ev.description.length > 5
              ? ev.description
              : (ev.subtitle || '').replace(/‚Üí.*$/, '').trim(); // supprime la ligne "‚Üí ... / ..."
        
          // D√©tails √©tendus pour le bouton ‚Äúvoir plus‚Äù
          const fullText = ev.subtitle || ev.description || '';
        
          grids.M3Q.insertAdjacentHTML('beforeend', `
            <article class="card">
              <div class="cover" style="background-image:url('${poster}');">
                ${badge}
              </div>
        
              <div class="content">
                <h3>${ev.title}</h3>
                <div class="meta">
                  ${ev.date_text || ''} 
                  ${ev.time ? ' ¬∑ ' + ev.time : ''}
                </div>
        
                <p class="synopsis" data-full="${fullText.replace(/"/g, '&quot;')}">
                  ${summary}
                </p>
        
                <button class="toggle-btn">Voir plus</button>
              </div>
        
              <div class="actions">
                <a class="ghost" href="${ev.source}" target="_blank">Infos</a>
                <a class="btn" href="${ev.ticket || ev.source}" target="_blank">Billetterie</a>
              </div>
            </article>
          `);
        });
        updateCarouselVisibility('M3Q');

        
        bindToggleButtons();
      }

      /* === CARROUSEL FLUIDE === */
      function setupCarousels() {
        // ‚úÖ Ne pas activer les boutons sur mobile
        if (window.innerWidth <= 768) return;
        
        document.querySelectorAll('.carousel-btn').forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
        });
      
        document.querySelectorAll('.carousel-btn').forEach(btn => {
          newBtn = btn; // r√©f√©rence au nouveau bouton
          btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const grid = document.getElementById(targetId);
            if (!grid) return;
      
            const container = grid.closest('.carousel-container');
            const visibleWidth = container.offsetWidth;
            const scrollAmount = visibleWidth * 0.9;
      
            const current = parseFloat(grid.dataset.offset || 0);
            let next = current;
      
            if (btn.classList.contains('left')) {
              next = Math.min(current + scrollAmount, 0);
            } else {
              const maxScroll = -(grid.scrollWidth - visibleWidth);
              next = Math.max(current - scrollAmount, maxScroll);
            }
      
            grid.style.transform = `translateX(${next}px)`;
            grid.dataset.offset = next;
          });
        });
      }


      function filterEvents() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const checkboxes = Array.from(document.querySelectorAll('.filters input[type="checkbox"]'));
        const checkedValues = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
      
        const cgrGlobal = document.querySelector('.dropdown-toggle input[value="CGR"]');
        const cgrSubs = Array.from(document.querySelectorAll('.dropdown-content input[type="checkbox"]'));
        const activeCGRSubs = cgrSubs.filter(cb => cb.checked).map(cb => cb.value);
      
        const filtered = allEvents.filter(ev => {
          const textMatch =
            ev.title?.toLowerCase().includes(query) ||
            ev.description?.toLowerCase().includes(query) ||
            ev.cinema?.toLowerCase().includes(query);
      
          let match = false;
      
          // üé¨ Gestion CGR
          if (ev.cinema?.startsWith('CGR')) {
            if (!cgrGlobal.checked) return false;
            if (activeCGRSubs.length === 0) return true;
            match = activeCGRSubs.includes(ev.cinema);
          } else {
            match = checkedValues.some(f => ev.cinema?.toLowerCase().includes(f.toLowerCase()));
          }
      
          return textMatch && match;
        });
      
        renderAll(filtered);
        setupCarousels();
      }

      /* === INITIALISATION === */
      (async function() {
          const data = await loadEvents();
          allEvents = data.events || [];
        
          renderAll(allEvents);
          setupCarousels();
        
          // Recherche texte
          document.getElementById('searchInput').addEventListener('input', filterEvents);
        
          // Filtres classiques
          document.querySelectorAll('.filters input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', filterEvents);
          });
        
          // üîÅ Synchronisation CGR principal ‚Üî sous-cin√©s
          const cgrGlobal = document.querySelector('.dropdown-toggle input[value="CGR"]');
          const cgrSubs = Array.from(document.querySelectorAll('.dropdown-content input[type="checkbox"]'));
        
          cgrGlobal.addEventListener('change', () => {
            cgrSubs.forEach(cb => (cb.checked = cgrGlobal.checked));
            filterEvents();
          });
        
          cgrSubs.forEach(cb => {
            cb.addEventListener('change', () => {
              const anyChecked = cgrSubs.some(sub => sub.checked);
              cgrGlobal.checked = anyChecked;
              filterEvents();
            });
          });
        
          // üîΩ Gestion ouverture/fermeture menu dropdown
          const dropdown = document.querySelector('.dropdown');
          const toggle = dropdown.querySelector('.dropdown-toggle');
          const checkbox = toggle.querySelector('input[type="checkbox"]');
        
          checkbox.addEventListener('click', e => {
            e.stopPropagation();
            setTimeout(() => filterEvents(), 50);
          });
        
          toggle.addEventListener('click', e => {
            if (e.target === checkbox) return;
            e.preventDefault();
            dropdown.classList.toggle('active');
          });
        
          document.addEventListener('click', e => {
            document.querySelectorAll('.dropdown.active').forEach(d => {
              if (!d.contains(e.target)) d.classList.remove('active');
            });
          });
        })();
    </script>
  </body>
</html>
